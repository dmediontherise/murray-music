<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Murray's Music Theory (Web Edition)</title>
    <style>
        body { font-family: monospace; background: #222; color: #eee; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { background: #333; padding: 10px 20px; border-bottom: 2px solid #555; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.2rem; }
        
        #main-layout { display: flex; flex: 1; overflow: hidden; }
        
        /* Sidebar */
        #sidebar { width: 250px; background: #2a2a2a; border-right: 1px solid #444; overflow-y: auto; padding: 10px; }
        .section-title { color: #888; text-transform: uppercase; font-size: 0.8rem; margin-top: 20px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .nav-item { padding: 8px 10px; cursor: pointer; color: #bbb; border-radius: 4px; margin-bottom: 2px; }
        .nav-item:hover { background: #333; color: #fff; }
        .nav-item.active { background: #444; color: #fff; font-weight: bold; border-left: 3px solid #0f0; }

        /* Content */
        #content { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        
        .panel { background: #333; padding: 15px; border-radius: 8px; border: 1px solid #444; }
        #info-panel h2 { margin-top: 0; color: #0f0; }
        
        #viz-container { text-align: center; overflow-x: auto; padding: 20px 0; background: #111; border-top: 2px solid #555; }
        
        /* Piano CSS */
        .piano { display: inline-flex; position: relative; height: 120px; user-select: none; }
        .key { border: 1px solid #000; box-sizing: border-box; }
        .white-key { width: 30px; height: 120px; background: #fff; z-index: 1; border-radius: 0 0 3px 3px; }
        .white-key.active { background: #0f0; box-shadow: 0 0 10px #0f0; }
        .black-key { width: 20px; height: 70px; background: #000; position: absolute; z-index: 2; margin-left: -10px; border-radius: 0 0 3px 3px; }
        .black-key.active { background: #0f0; box-shadow: 0 0 10px #0f0; }
        
        #sheet-music-img { background: white; padding: 10px; border-radius: 4px; max-width: 100%; }
        
        .status-bar { padding: 5px 20px; background: #111; font-size: 0.8rem; color: #666; display: flex; justify-content: space-between; }
        .status-ok { color: #0f0; }
        .status-err { color: #f00; }
    </style>
</head>
<body>

<header>
    <h1>Murray's Music Theory v2.0</h1>
    <div id="midi-status">MIDI: <span class="status-err">Not Connected</span></div>
</header>

<div id="main-layout">
    <nav id="sidebar">
        <div class="nav-item active" onclick="setMode('FREE')">Free Play</div>
        
        <div class="section-title">Beginner Course</div>
        <div id="beginner-list"></div>
        
        <div class="section-title">Advanced Course</div>
        <div id="advanced-list"></div>
    </nav>
    
    <main id="content">
        <div id="info-panel" class="panel">
            <h2 id="topic-title">Free Play</h2>
            <p id="topic-desc">Play your MIDI keyboard to see notes and analysis.</p>
            <div id="analysis-output" style="margin-top: 10px; font-family: monospace; color: #aaa;">
                Waiting for input...
            </div>
        </div>

        <div class="panel" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <h3>Sheet Music Generator</h3>
            <button onclick="generateSheet()" style="padding: 8px 16px; cursor: pointer; background: #444; color: white; border: none; margin-bottom: 10px;">Generate SVG from Active Notes</button>
            <div id="sheet-container">
                <!-- SVG goes here -->
            </div>
        </div>
    </main>
</div>

<div id="viz-container">
    <div id="piano" class="piano"></div>
</div>

<div class="status-bar">
    <span>Active Notes: <span id="active-notes-text">None</span></span>
    <span>v2.0 Web Client</span>
</div>

<script>
    // State
    let activeNotes = new Set(); // MIDI numbers
    let currentMode = "FREE";
    let curriculumData = {};

    // 1. Initialize Piano UI (4 Octaves: C3 to B6)
    const pianoEl = document.getElementById('piano');
    const startOctave = 3;
    const numOctaves = 4;
    
    function createPiano() {
        pianoEl.innerHTML = '';
        const whiteKeys = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
        let leftOffset = 0;
        
        for(let o=0; o<numOctaves; o++) {
            const oct = startOctave + o;
            
            whiteKeys.forEach((note, i) => {
                // White Key
                const wk = document.createElement('div');
                wk.className = 'key white-key';
                wk.dataset.note = `${note}${oct}`;
                const midi = getMidi(note, oct);
                wk.dataset.midi = midi;
                pianoEl.appendChild(wk);
                
                // Black Key (if exists after this white key)
                // C(0), D(1) -> C#, D#
                // F(3), G(4), A(5) -> F#, G#, A#
                if ([0, 1, 3, 4, 5].includes(i)) {
                    const bk = document.createElement('div');
                    bk.className = 'key black-key';
                    const sharp = note + '#';
                    bk.dataset.note = `${sharp}${oct}`;
                    bk.dataset.midi = midi + 1;
                    
                    // Position relative to the white key we just added
                    // CSS absolute positioning handles the overlap if we calculate left
                    // But simpler: Just append it and use margin-left negative on CSS
                    // We need to place it after the white key in DOM but positioned correctly?
                    // Let's use left style.
                    bk.style.left = (leftOffset + 20) + 'px'; // 30px white key width approx
                    pianoEl.appendChild(bk);
                }
                leftOffset += 30; // 30px width per white key
            });
        }
        pianoEl.style.width = leftOffset + 'px';
    }
    
    function getMidi(note, octave) {
        const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        return (octave + 1) * 12 + notes.indexOf(note);
    }

    createPiano();

    // 2. Fetch Curriculum
    fetch('/api/curriculum').then(r => r.json()).then(data => {
        curriculumData = data;
        const bgList = document.getElementById('beginner-list');
        const advList = document.getElementById('advanced-list');
        
        data.beginner.forEach(topic => {
            const div = document.createElement('div');
            div.className = 'nav-item';
            div.innerText = topic;
            div.onclick = () => setTopic(topic);
            bgList.appendChild(div);
        });
        
        data.advanced.forEach(topic => {
            const div = document.createElement('div');
            div.className = 'nav-item';
            div.innerText = topic;
            div.onclick = () => setTopic(topic);
            advList.appendChild(div);
        });
    });

    function setMode(mode) {
        currentMode = mode;
        document.getElementById('topic-title').innerText = "Free Play";
        document.getElementById('topic-desc').innerText = "Play freely.";
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
    }

    function setTopic(topic) {
        currentMode = "TOPIC";
        document.getElementById('topic-title').innerText = topic;
        const desc = curriculumData.descriptions[topic] || "No description.";
        document.getElementById('topic-desc').innerText = desc;
        
        // Highlight active nav
        document.querySelectorAll('.nav-item').forEach(e => {
            if(e.innerText === topic) e.classList.add('active');
            else e.classList.remove('active');
        });
    }

    // 3. Web MIDI
    if (navigator.requestMIDIAccess) {
        navigator.requestMIDIAccess().then(onMIDISuccess, onMIDIFailure);
    } else {
        document.getElementById('midi-status').innerHTML = "Web MIDI Not Supported in this browser.";
    }

    function onMIDISuccess(midiAccess) {
        document.getElementById('midi-status').innerHTML = "MIDI: <span class='status-ok'>Ready</span>";
        for (var input of midiAccess.inputs.values()) {
            input.onmidimessage = getMIDIMessage;
        }
    }

    function onMIDIFailure() {
        document.getElementById('midi-status').innerHTML = "MIDI: <span class='status-err'>Failed</span>";
    }

    function getMIDIMessage(message) {
        var command = message.data[0];
        var note = message.data[1];
        var velocity = (message.data.length > 2) ? message.data[2] : 0;

        // Note On
        if (command === 144 && velocity > 0) {
            noteOn(note);
        }
        // Note Off
        if (command === 128 || (command === 144 && velocity === 0)) {
            noteOff(note);
        }
    }

    function noteOn(midi) {
        if(activeNotes.has(midi)) return;
        activeNotes.add(midi);
        updateVisuals();
        analyze();
    }

    function noteOff(midi) {
        activeNotes.delete(midi);
        updateVisuals();
        analyze(); // Update analysis on release too
    }

    // 4. Update UI
    function updateVisuals() {
        // Clear all
        document.querySelectorAll('.key').forEach(k => k.classList.remove('active'));
        
        // Highlight active
        activeNotes.forEach(midi => {
            const el = document.querySelector(`.key[data-midi="${midi}"]`);
            if(el) el.classList.add('active');
        });
        
        // Note names logic for display (simple map)
        const notes = Array.from(activeNotes).map(m => {
            const n = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"][m % 12];
            const oct = Math.floor(m / 12) - 1;
            return `${n}${oct}`;
        });
        
        document.getElementById('active-notes-text').innerText = notes.join(', ') || "None";
        return notes; // Return names for API
    }

    // 5. Backend Communication
    function analyze() {
        if(activeNotes.size === 0) {
            document.getElementById('analysis-output').innerText = "Waiting for input...";
            return;
        }

        const noteNames = updateVisuals(); // Get list like ["C4", "E4"]
        
        fetch('/api/analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ notes: noteNames })
        })
        .then(r => r.json())
        .then(data => {
            let html = `<strong>Root:</strong> ${data.root}<br>`;
            html += `<strong>Intervals:</strong> ${data.intervals.join(', ')}`;
            document.getElementById('analysis-output').innerHTML = html;
        });
    }

    function generateSheet() {
        const noteNames = updateVisuals();
        if(noteNames.length === 0) return;

        fetch('/api/generate-sheet', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ notes: noteNames })
        })
        .then(r => r.blob())
        .then(blob => {
            const url = URL.createObjectURL(blob);
            const container = document.getElementById('sheet-container');
            container.innerHTML = `<img src="${url}" id="sheet-music-img" alt="Sheet Music">`;
        });
    }
</script>

</body>
</html>
