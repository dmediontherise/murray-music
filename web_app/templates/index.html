<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Murray's Theory v8.1</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #F5F5F7; --bg-surface: #FFFFFF; --accent: #0071E3;
            --success: #34C759; --error: #FF3B30; --warning: #FF9F0A;
            --header-h: 60px; --piano-h: 180px; --sidebar-w: 280px;
        }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); margin: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { height: var(--header-h); background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 100; flex-shrink: 0; }
        .brand { font-weight: 700; font-size: 1.1rem; }
        #midi-badge { font-size: 0.75rem; font-weight: 600; padding: 4px 10px; background: #eee; border-radius: 12px; color: #666; transition: 0.3s; }
        #midi-badge.connected { background: #E0F8E5; color: #1E7E34; }

        /* MAIN */
        #app { flex: 1; display: flex; overflow: hidden; position: relative; }
        
        /* SIDEBAR */
        #sidebar { width: var(--sidebar-w); background: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; overflow-y: auto; z-index: 50; transition: transform 0.3s ease; }
        .menu-head { padding: 20px 20px 8px; font-size: 0.75rem; font-weight: 700; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
        .menu-item { padding: 10px 20px; font-size: 0.95rem; cursor: pointer; border-left: 3px solid transparent; }
        .menu-item:hover { background: #f5f5f5; }
        .menu-item.active { background: #eff6ff; color: var(--accent); border-left-color: var(--accent); font-weight: 600; }

        /* CONTENT */
        #content { flex: 1; display: flex; flex-direction: column; position: relative; background: var(--bg-body); overflow: hidden; }
        #scroll-view { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: calc(var(--piano-h) + 40px); }

        .card { background: #fff; border-radius: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); max-width: 800px; margin: 0 auto; padding: 30px; text-align: center; border: 1px solid rgba(0,0,0,0.05); transition: 0.3s; }
        .card.success { border-color: var(--success); box-shadow: 0 0 0 2px var(--success); }
        
        h2 { margin: 0 0 10px; font-size: 1.6rem; }
        .subtitle { color: #666; margin-bottom: 20px; line-height: 1.5; }
        .context-box { background: #F2F2F7; border-radius: 12px; padding: 15px; margin: 20px 0; text-align: left; font-size: 0.9rem; display: flex; gap: 10px; align-items: start; }
        
        #staff-svg { width: 100%; height: auto; max-height: 150px; margin: 20px 0; }
        
        /* PROGRESS BAR */
        #sequence-tracker { display: flex; gap: 5px; justify-content: center; margin-top: 10px; height: 8px; }
        .seq-step { width: 30px; height: 6px; background: #ddd; border-radius: 3px; transition: 0.2s; }
        .seq-step.done { background: var(--success); }

        /* PIANO (Pinned) */
        #piano-wrap { height: var(--piano-h); background: #fff; border-top: 1px solid #ddd; flex-shrink: 0; position: relative; z-index: 80; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); display: flex; justify-content: center; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        
        .piano-keys { position: relative; height: 100%; display: flex; padding: 0 20px; user-select: none; }
        
        .white-key { width: 50px; height: 100%; background: linear-gradient(#fff, #f5f5f5); border: 1px solid #bbb; border-top: none; border-radius: 0 0 6px 6px; z-index: 1; cursor: pointer; position: relative; flex-shrink: 0; }
        .white-key.active { background: var(--accent); transform: translateY(2px); box-shadow: inset 0 3px 5px rgba(0,0,0,0.2); border-color: #005bb5; }
        .white-key.hint { background: #FFF9C4; border-bottom: 6px solid var(--warning); }

        .black-key { width: 30px; height: 60%; background: linear-gradient(#333, #000); position: absolute; top: 0; z-index: 10; border-radius: 0 0 4px 4px; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); cursor: pointer; pointer-events: auto; }
        .black-key.active { background: linear-gradient(var(--accent), #004499); transform: translateY(2px); }
        .black-key.hint { border: 2px solid var(--warning); background: #443300; }

        .label-n { position: absolute; bottom: 25px; left: 0; right: 0; text-align: center; font-size: 0.75rem; font-weight: 700; color: #ccc; pointer-events: none; }
        .label-k { position: absolute; bottom: 6px; left: 0; right: 0; text-align: center; font-size: 0.65rem; font-weight: 600; color: #aaa; text-transform: uppercase; pointer-events: none; }
        .active .label-n, .active .label-k { color: #fff; }

        #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 40; backdrop-filter: blur(2px); }
        #menu-btn { display: none; background: none; border: none; font-size: 1.4rem; cursor: pointer; }

        /* BUTTONS */
        .btn { padding: 12px 24px; border-radius: 30px; border: none; font-weight: 600; cursor: pointer; font-size: 1rem; margin: 5px; transition: 0.2s; }
        .btn-pri { background: var(--accent); color: #fff; box-shadow: 0 4px 10px rgba(0,113,227,0.3); }
        .btn-pri:active { transform: scale(0.96); }
        .btn-sec { background: #eee; color: #333; }

        @media (max-width: 768px) {
            #sidebar { position: fixed; top: 0; left: 0; bottom: 0; transform: translateX(-100%); width: 85%; }
            #sidebar.open { transform: translateX(0); }
            #overlay.visible { display: block; }
            #menu-btn { display: block; }
            #piano-wrap { justify-content: flex-start; height: 160px; }
            .white-key { width: 44px; } .black-key { width: 26px; }
            #scroll-view { padding: 15px; padding-bottom: 180px; }
        }
    </style>
</head>
<body>

<div id="overlay" onclick="toggleMenu()"></div>

<header>
    <div style="display:flex; align-items:center; gap:15px;">
        <button id="menu-btn" onclick="toggleMenu()">â˜°</button>
        <div class="brand">Murray's Theory</div>
    </div>
    <div id="midi-badge">MIDI Off</div>
</header>

<div id="app">
    <nav id="sidebar">
        <div class="menu-head">Explore</div>
        <div class="menu-item active" onclick="setMode('FREE')">Free Play</div>
        <div class="menu-head">Book 1: Basic</div>
        <div id="bg-list"></div>
        <div class="menu-head">Book 2: Advanced</div>
        <div id="adv-list"></div>
    </nav>

    <div id="content">
        <div id="scroll-view">
            <div class="card" id="drill-card">
                <h2 id="drill-title">Free Play</h2>
                <div class="subtitle" id="drill-desc">Explore harmony freely.</div>
                
                <div class="context-box" id="context-box" style="display:none;">
                    <span style="font-size:1.4rem;">ðŸŽµ</span>
                    <div id="context-text">...</div>
                </div>

                <div id="staff-container"></div>
                <div id="sequence-tracker"></div> <!-- Visual dots for sequences -->

                <div style="margin-top:20px; min-height:50px;">
                    <button class="btn btn-sec" id="hint-btn" onclick="showHint()" style="display:none;">ðŸ’¡ Hint</button>
                    <button class="btn btn-pri" id="next-btn" onclick="nextDrill()" style="display:none;">Next Challenge â†’</button>
                    <div id="msg-complete" style="display:none; color:var(--success); font-weight:700; font-size:1.2rem;">Section Complete! ðŸŽ‰</div>
                </div>
            </div>
        </div>
        
        <div id="piano-wrap">
            <div id="piano-keys" class="piano-keys"></div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. ROBUST STATE MACHINE
    // ==========================================
    const state = {
        active: new Set(),      // Currently held MIDI notes
        targetSet: new Set(),   // Unordered target (Chords)
        targetSeq: [],          // Ordered target (Scales)
        seqProgress: 0,         // Current index in sequence
        mode: "FREE",
        audioCtx: null,
        oscs: new Map(),
        topic: null,
        idx: 0,
        isChord: true           // Toggle between Chord vs Sequence checking
    };

    // ==========================================
    // 2. POLYPHONIC AUDIO ENGINE
    // ==========================================
    function initAudio() {
        if(!state.audioCtx) {
            state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            state.audioCtx.resume();
        }
    }
    
    function playTone(m) {
        initAudio();
        if(state.oscs.has(m)) return; // Prevent stacking
        
        const o = state.audioCtx.createOscillator();
        const g = state.audioCtx.createGain();
        o.type = 'triangle';
        o.frequency.value = 440 * Math.pow(2, (m-69)/12);
        
        const t = state.audioCtx.currentTime;
        g.gain.setValueAtTime(0, t);
        g.gain.linearRampToValueAtTime(0.3, t + 0.02);
        g.gain.exponentialRampToValueAtTime(0.2, t + 0.5); // Sustain
        
        o.connect(g); g.connect(state.audioCtx.destination);
        o.start();
        state.oscs.set(m, {o,g});
    }
    
    function stopTone(m) {
        if(!state.oscs.has(m)) return;
        const {o,g} = state.oscs.get(m);
        const t = state.audioCtx.currentTime;
        g.gain.cancelScheduledValues(t);
        g.gain.linearRampToValueAtTime(0, t + 0.1);
        o.stop(t + 0.1);
        setTimeout(() => { o.disconnect(); g.disconnect(); }, 150);
        state.oscs.delete(m);
    }

    // ==========================================
    // 3. UI RENDERING (RAF LOOP)
    // ==========================================
    // Using requestAnimationFrame for smooth UI updates regardless of input speed
    let rafId;
    function startRenderLoop() {
        if(rafId) cancelAnimationFrame(rafId);
        function loop() {
            renderPiano();
            rafId = requestAnimationFrame(loop);
        }
        loop();
    }

    function renderPiano() {
        // Efficient class toggling
        const keys = document.getElementById('piano-keys').children; // Mix of white/black keys
        for (let key of keys) {
            const m = parseInt(key.dataset.m);
            if(state.active.has(m)) key.classList.add('active');
            else key.classList.remove('active');
        }
    }

    // ==========================================
    // 4. INTELLIGENT INPUT HANDLING
    // ==========================================
    function noteOn(m) {
        if(state.active.has(m)) return;
        state.active.add(m);
        playTone(m);
        checkLogic(m); // Check progress on every new note
    }
    
    function noteOff(m) {
        state.active.delete(m);
        stopTone(m);
        // We don't check logic on note off usually, unless we want to enforce holding
    }

    function checkLogic(lastNoteMidi) {
        if(state.mode === "FREE") return;

        if (state.isChord) {
            // CHORD LOGIC: Check if current active notes MATCH target set
            // Allow superset? No, strict match usually better for theory.
            // But let's allow extra notes if they are just octave doublings? No, strict.
            
            const match = state.targetSet.size === state.active.size && 
                          [...state.targetSet].every(x => state.active.has(x));
            
            if (match) successState();
            
        } else {
            // SEQUENCE LOGIC: Check if lastNoteMidi matches the NEXT note in sequence
            const expectedMidi = state.targetSeq[state.seqProgress];
            if (lastNoteMidi === expectedMidi) {
                state.seqProgress++;
                updateSeqUI();
                
                if (state.seqProgress >= state.targetSeq.length) {
                    successState();
                }
            } else {
                // If they played a WRONG note (not in sequence at all?), reset?
                // Or just ignore? Let's ignore unless they mess up badly.
                // Strict: If they play a note that isn't the next one, reset progress.
                // But polyphony might trigger weird order.
                // Let's just check if it matches expectation.
            }
        }
    }

    function successState() {
        const card = document.getElementById('drill-card');
        card.className = "card success";
        document.getElementById('drill-desc').innerHTML = "<b style='color:var(--success)'>Excellent!</b>";
        document.getElementById('next-btn').style.display = 'inline-block';
        document.getElementById('hint-btn').style.display = 'none';
        
        // Auto-play success sound?
    }

    function updateSeqUI() {
        const dots = document.querySelectorAll('.seq-step');
        dots.forEach((d, i) => {
            if(i < state.seqProgress) d.classList.add('done');
            else d.classList.remove('done');
        });
    }

    // ==========================================
    // 5. PIANO BUILDER
    // ==========================================
    const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
    const keyMap = {
        'z':48,'s':49,'x':50,'d':51,'c':52,'v':53,'g':54,'b':55,'h':56,'n':57,'j':58,'m':59,',':60,
        'q':60,'2':61,'w':62,'3':63,'e':64,'r':65,'5':66,'t':67,'6':68,'y':69,'7':70,'u':71,'i':72,'9':73,'o':74,'p':76
    };

    function buildPiano() {
        const container = document.getElementById('piano-keys');
        container.innerHTML = '';
        const wWidth = window.innerWidth <= 768 ? 44 : 50; 
        let wCount = 0;
        
        // Render Whites
        for(let m=48; m<=83; m++) {
            if(![1,3,6,8,10].includes(m%12)) {
                const k = document.createElement('div');
                k.className = 'white-key';
                k.dataset.m = m;
                k.innerHTML = `<div class="label-n">${noteNames[m%12]}</div>`;
                const char = Object.keys(keyMap).find(x => keyMap[x] === m);
                if(char) k.innerHTML += `<div class="label-k">${char.toUpperCase()}</div>`;
                bindEvents(k, m);
                container.appendChild(k);
                wCount++;
            }
        }
        container.style.width = (wCount * wWidth) + 'px';
        
        // Render Blacks
        let wIdx = 0;
        for(let m=48; m<=83; m++) {
            if([1,3,6,8,10].includes(m%12)) {
                const k = document.createElement('div');
                k.className = 'black-key';
                k.dataset.m = m;
                const bWidth = window.innerWidth <= 768 ? 26 : 30;
                k.style.left = ((wIdx * wWidth) - (bWidth/2)) + 'px';
                bindEvents(k, m);
                container.appendChild(k);
            } else wIdx++;
        }
    }

    function bindEvents(el, m) {
        const on = e => { e.preventDefault(); noteOn(m); };
        const off = e => { e.preventDefault(); noteOff(m); };
        el.addEventListener('mousedown', on); el.addEventListener('mouseup', off); el.addEventListener('mouseleave', off);
        el.addEventListener('touchstart', on, {passive:false}); el.addEventListener('touchend', off, {passive:false});
    }

    // ==========================================
    // 6. GAME CONTROL
    // ==========================================
    window.setMode = m => {
        state.mode = m; resetUI();
        document.getElementById('drill-title').innerText = "Free Play";
        document.getElementById('drill-desc').innerText = "Explore harmony.";
        document.getElementById('context-box').style.display = 'none';
        document.getElementById('staff-container').innerHTML = '';
        document.getElementById('sequence-tracker').innerHTML = '';
    }

    window.setTopic = t => {
        state.mode = "DRILL"; state.topic = t; state.idx = 0; resetUI();
        document.querySelectorAll('.menu-item').forEach(e => e.classList.toggle('active', e.innerText === t));
        loadChallenge();
    }

    window.nextDrill = () => { state.idx++; loadChallenge(); }

    function loadChallenge() {
        resetUI();
        document.getElementById('drill-desc').innerText = "Loading...";
        
        fetch('/api/challenge', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({topic: state.topic, challenge_index: state.idx})
        }).then(r=>r.json()).then(d => {
            if(d.no_more_challenges) {
                document.getElementById('drill-title').innerText = "Complete!";
                document.getElementById('msg-complete').style.display = 'block';
                document.getElementById('drill-desc').innerText = "";
                return;
            }

            document.getElementById('drill-title').innerText = d.instruction;
            document.getElementById('drill-desc').innerText = "Play on the piano.";
            document.getElementById('staff-container').innerHTML = d.svg;
            
            // Context
            if(d.context) {
                document.getElementById('context-box').style.display = 'flex';
                document.getElementById('context-text').innerText = d.context;
            }

            // Logic Setup
            const targets = d.target_notes.map(n => {
                const l = n.slice(0, -1); const o = parseInt(n.slice(-1));
                return (o+1)*12 + noteNames.indexOf(l);
            });

            // Determine if Chord or Sequence?
            // Heuristic: If instruction contains "Sequence", "Scale", or "Arpeggio", it's sequential.
            // Or assume from API 'type' field.
            // We need to pass 'type' from backend or infer. 
            // Currently backend returns SVG. Let's infer from note count for now or modify backend later.
            // For now, if > 1 note and type isn't explicitly chord, treat as chord? 
            // Actually, scales are sequences. 
            // Let's assume EVERYTHING is a chord unless we detect "Scale" in instruction.
            
            const isScale = d.instruction.includes("Scale") || d.instruction.includes("Sequence") || d.instruction.includes("Circle");
            state.isChord = !isScale;
            
            if(isScale) {
                state.targetSeq = targets;
                state.seqProgress = 0;
                // Render dots
                const track = document.getElementById('sequence-tracker');
                track.innerHTML = targets.map(() => '<div class="seq-step"></div>').join('');
            } else {
                state.targetSet = new Set(targets);
                document.getElementById('sequence-tracker').innerHTML = '';
            }
            
            // Hint data
            state.targetMidis = new Set(targets);
            document.getElementById('hint-btn').style.display = 'inline-block';
        });
    }

    function resetUI() {
        document.getElementById('drill-card').className = 'card';
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('hint-btn').style.display = 'none';
        document.getElementById('msg-complete').style.display = 'none';
        document.querySelectorAll('.hint').forEach(e => e.classList.remove('hint'));
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('overlay').classList.remove('visible');
    }

    window.showHint = () => {
        state.targetMidis.forEach(m => {
            const el = document.querySelector(`div[data-m="${m}"]`);
            if(el) el.classList.add('hint');
        });
    }
    
    window.toggleMenu = () => {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('visible');
    };

    // BOOTSTRAP
    startRenderLoop();
    buildPiano();
    window.addEventListener('resize', buildPiano);
    
    // Keyboard
    document.addEventListener('keydown', e => {
        if(e.repeat) return;
        const k = e.key.toLowerCase();
        if(keyMap[k]) noteOn(keyMap[k]);
    });
    document.addEventListener('keyup', e => {
        const k = e.key.toLowerCase();
        if(keyMap[k]) noteOff(keyMap[k]);
    });

    // MIDI
    if(navigator.requestMIDIAccess) {
        navigator.requestMIDIAccess().then(m => {
            document.getElementById('midi-badge').innerText = "MIDI Ready";
            document.getElementById('midi-badge').classList.add('connected');
            for(let i of m.inputs.values()) i.onmidimessage = msg => {
                const [c,n,v] = msg.data;
                if(c===144 && v>0) noteOn(n);
                if(c===128 || (c===144 && v===0)) noteOff(n);
            };
        });
    }

    // Load Data
    fetch('/api/curriculum').then(r=>r.json()).then(d => {
        const bg=document.getElementById('bg-list'), ad=document.getElementById('adv-list');
        d.beginner.forEach(t => bg.innerHTML += `<div class="menu-item" onclick="setTopic('${t}')">${t}</div>`);
        d.advanced.forEach(t => ad.innerHTML += `<div class="menu-item" onclick="setTopic('${t}')">${t}</div>`);
    });

</script>
</body>
</html>
